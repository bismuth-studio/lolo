{"version":3,"file":"index.es.js","sources":["../src/config.js","../src/preact/index.js"],"sourcesContent":["/**\n * @function config\n * @instance instance\n * @prop {String} className - The default className's for your PIMG(s)\n * @prop {String} placeholderClassName - The default placeholder className's for your image(s)\n * @prop {Function} onError - Determines how errors are handled in the component\n * @prop {Boolean | Object} dataSaver - Choose to use dataSaver mode\n * @prop {String} dataSaver.wrapperClassName - DataSaver wrapper className\n * @prop {String} dataSaver.buttonClassName - DataSaver button className\n */\n\nconst config = (() => {\n\tlet instance\n\n\tconst init = ({\n\t\tbuttonClassName = 'pimg__btn',\n\t\tclassName = 'pimg',\n\t\tdataSaver = false,\n\t\tfetchOnDemand = false,\n\t\terror = null,\n\t\tplaceholderClassName = 'pimg__placeholder',\n\t\twrapperClassName = 'pimg__wrapper'\n\t} = {}) => {\n\t\tif (typeof dataSaver !== 'object' && dataSaver === true) {\n\t\t\tdataSaver = {\n\t\t\t\twrapperClassName,\n\t\t\t\tbuttonClassName\n\t\t\t}\n\t\t} else if (typeof dataSaver === 'object') {\n\t\t\tdataSaver = {\n\t\t\t\twrapperClassName: dataSaver.wrapperClassName || wrapperClassName,\n\t\t\t\tbuttonClassName: dataSaver.buttonClassName || buttonClassName\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tonError: error => {\n\t\t\t\terror = error\n\t\t\t},\n\t\t\tgetClassName: () => {\n\t\t\t\treturn className\n\t\t\t},\n\t\t\tgetButtonClassName: () => {\n\t\t\t\treturn buttonClassName\n\t\t\t},\n\t\t\tgetDataSaver: () => {\n\t\t\t\treturn dataSaver\n\t\t\t},\n\t\t\tgetError: cb => {\n\t\t\t\treturn cb(error)\n\t\t\t},\n\t\t\tgetFetchOnDemand: () => {\n\t\t\t\treturn fetchOnDemand\n\t\t\t},\n\t\t\tgetPlaceholderClassName: () => {\n\t\t\t\treturn placeholderClassName\n\t\t\t},\n\t\t\tgetWrapperClassName: () => {\n\t\t\t\treturn wrapperClassName\n\t\t\t}\n\t\t}\n\t}\n\n\treturn params => (instance ? instance : (instance = init(params)))\n})()\n\nexport default config\n","import { h, Component } from 'preact'\nimport PropTypes from 'prop-types'\nimport 'whatwg-fetch'\n\nimport config from '../config'\n\nclass Image extends Component {\n\tstate = {\n\t\tblob: null,\n\t\tloading: true,\n\t\tdelayed: false,\n\t\tplaceholder: null\n\t}\n\n\tsetBlob = blob => this.setState({ blob })\n\n\tsetPlaceholder = placeholder => this.setState({ placeholder })\n\n\tsetLoading = loading => this.setState({ loading })\n\n\tdelayFetchingImage = delayed => this.setState({ delayed })\n\n\tfetchImage = src => {\n\t\tfetch(src)\n\t\t\t.then(res => res.blob())\n\t\t\t.then(res => {\n\t\t\t\tthis.setBlob(URL.createObjectURL(res))\n\t\t\t\tthis.setLoading(false)\n\t\t\t\tthis.delayFetchingImage(false)\n\t\t\t})\n\t}\n\n\timage = () => this.imgElement\n\n\tfetchOnDemand = src => {\n\t\ttry {\n\t\t\tlet observer = new IntersectionObserver(entries => {\n\t\t\t\tlet image = entries[0]\n\n\t\t\t\tif (image.isIntersecting) {\n\t\t\t\t\tthis.fetchImage(src)\n\t\t\t\t\tthis.delayFetchingImage(false)\n\t\t\t\t\tobserver.disconnect()\n\t\t\t\t}\n\t\t\t})\n\n\t\t\tobserver.observe(this.image())\n\t\t} catch (_) {\n\t\t\t// Fail gracefully\n\t\t\tconsole.warn('fetchOnDemand not supported on this browser')\n\t\t\tthis.fetchImage(src)\n\t\t\tthis.delayFetchingImage(false)\n\t\t}\n\t}\n\n\tcomponentDidMount() {\n\t\tconst { dataSaver, src, fetchOnDemand, placeholder } = this.props\n\n\t\tconst { getDataSaver, getFetchOnDemand } = config()\n\n\t\t// If it's a Cloudinary Image\n\t\tif (src && src.includes('cloudinary')) {\n\t\t\tlet placeholder =\n\t\t\t\tplaceholder || src.replace('/upload/', '/upload/c_thumb,w_30/')\n\n\t\t\tthis.setPlaceholder(placeholder)\n\t\t}\n\n\t\tif (dataSaver || getDataSaver()) {\n\t\t\tthis.delayFetchingImage(true)\n\t\t} else if (fetchOnDemand || getFetchOnDemand()) {\n\t\t\tthis.setLoading(true)\n\t\t\tthis.fetchOnDemand(src)\n\t\t} else {\n\t\t\tthis.fetchImage(src)\n\t\t}\n\t}\n\n\tcomponentWillReceiveProps({ dataSaver, fetchOnDemand, src }) {\n\t\t// This will help when toggling DataSaver mode\n\t\tconst { getDataSaver, getFetchOnDemand } = config()\n\n\t\tif (dataSaver || getDataSaver()) {\n\t\t\tthis.delayFetchingImage(true)\n\t\t} else if (fetchOnDemand || getFetchOnDemand()) {\n\t\t\tthis.setLoading(true)\n\t\t\tthis.fetchOnDemand(src)\n\t\t} else {\n\t\t\tthis.fetchImage(src)\n\t\t}\n\t}\n\n\trender() {\n\t\tconst {\n\t\t\tclassName,\n\t\t\tdataSaver,\n\t\t\t// we don't actually need fetchOnDemand here,\n\t\t\t// added it so we can append the [rest] props\n\t\t\tfetchOnDemand,\n\t\t\tplaceholderClassName,\n\t\t\tsrc,\n\t\t\tplaceholder,\n\t\t\t...rest\n\t\t} = this.props\n\n\t\tconst { blob, delayed, loading } = this.state\n\n\t\tconst {\n\t\t\tgetButtonClassName,\n\t\t\tgetClassName,\n\t\t\tgetDataSaver,\n\t\t\tgetPlaceholderClassName,\n\t\t\tgetWrapperClassName\n\t\t} = config()\n\n\t\tconst classes = className\n\t\t\t? `${className} ${placeholderClassName || getPlaceholderClassName()}`\n\t\t\t: placeholderClassName\n\t\t\t\t? `${className || getClassName()} ${placeholderClassName}`\n\t\t\t\t: `${getClassName()} ${getPlaceholderClassName()}`\n\n\t\t// @props delayed for unaccounted state change\n\t\tif (((dataSaver || getDataSaver()) && loading) || delayed) {\n\t\t\treturn (\n\t\t\t\t<div className={getWrapperClassName()}>\n\t\t\t\t\t<img\n\t\t\t\t\t\tclassName={classes}\n\t\t\t\t\t\tsrc={placeholder || this.state.placeholder}\n\t\t\t\t\t\tref={i => (this.imgElement = i)}\n\t\t\t\t\t\t{...rest}\n\t\t\t\t\t/>\n\t\t\t\t\t<button\n\t\t\t\t\t\tclassName={getButtonClassName()}\n\t\t\t\t\t\tonClick={() => this.fetchImage(this.props.src)}\n\t\t\t\t\t>\n\t\t\t\t\t\tLoad image\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t)\n\t\t}\n\n\t\tif (loading) {\n\t\t\treturn (\n\t\t\t\t<img\n\t\t\t\t\tclassName={classes}\n\t\t\t\t\tsrc={placeholder || this.state.placeholder}\n\t\t\t\t\tref={i => (this.imgElement = i)}\n\t\t\t\t\t{...rest}\n\t\t\t\t/>\n\t\t\t)\n\t\t}\n\n\t\treturn (\n\t\t\t<img\n\t\t\t\tclassName={className ? className : getClassName()}\n\t\t\t\tsrc={blob}\n\t\t\t\t{...rest}\n\t\t\t/>\n\t\t)\n\t}\n}\n\nImage.propTypes = {\n\tsrc: PropTypes.string.isRequired\n}\n\nexport default Image\n\nexport { config }\n"],"names":["config","instance","init","buttonClassName","className","dataSaver","fetchOnDemand","error","placeholderClassName","wrapperClassName","cb","params","Image","state","setBlob","setState","blob","setPlaceholder","placeholder","setLoading","loading","delayFetchingImage","delayed","fetchImage","src","then","res","URL","createObjectURL","image","imgElement","observer","IntersectionObserver","entries","isIntersecting","disconnect","observe","_","warn","props","getDataSaver","getFetchOnDemand","includes","replace","rest","getButtonClassName","getClassName","getPlaceholderClassName","getWrapperClassName","classes","i","Component","propTypes","PropTypes","string","isRequired"],"mappings":"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"}